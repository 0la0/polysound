<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="custom-grainulator">
  <template>
    <style>
      :host {
        display: flex;
        flex-flow: row;
        flex-wrap: nowrap;
        font-size: 12px;
      }
      .grainulator {
        width: 200px;
        border: 1px solid black;
      }
      .grainulator-header {
        background-color: #999;
        width: 100%;
      }
      .grainulator-row {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: flex-start;
        align-items: stretch;

        min-height: 20px;
        height: 20px;
        margin: 10px 0;
        line-height: 30px;
      }
      .grainulator-button {
        width: 60px;
        height: 30px;
      }
      label {
        width: 50%;
      }
      .grainulator__param-box {
        display: none;
      }
      .grainulator__param-box--active {
        display: block;
      }
    </style>

    <div class="grainulator">
      <div class="grainulator-header" id="header">Grainulator Name</div>

      <div class="grainulator-row">
        <div class="grainulator-button">
          <simple-button button-model="{{buttonModel}}"></simple-button>
        </div>
      </div>

      <div class="grainulator-row" value="position">
        <label>Position</label>
        <slider-horizontal
          slider-value={{position}}
          lower-bound="0" upper-bound="1">
        </slider-horizontal>
      </div>

      <div class="grainulator-row" value="spread">
        <label>Spread</label>
        <slider-horizontal
          slider-value={{spread}}
          lower-bound="0" upper-bound="1">
        </slider-horizontal>
      </div>

      <div class="grainulator-row" value="loopTime">
        <label>Loop Time</label>
        <slider-horizontal
          slider-value={{loopTime}}
          lower-bound="0.01" upper-bound="1">
        </slider-horizontal>
      </div>

      <div class="grainulator-row" value="numVoices">
        <label>Num Voice</label>
        <slider-horizontal
          slider-value={{numVoices}}
          lower-bound="1" upper-bound="6">
        </slider-horizontal>
      </div>

      <div class="grainulator-row" value="pitch">
        <label>Pitch</label>
        <slider-horizontal
          slider-value={{pitch}}
          lower-bound="-12" upper-bound="12">
        </slider-horizontal>
      </div>

    </div>

    <div class="grainulator__param-box" id="paramBox">
      <parameter-sequencer parameterized={{parametized}}></parameter-sequencer>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      class CustomGrainulator {

        beforeRegister() {
          this.is = 'custom-grainulator';

          this.properties = {
            instrumentSet: {
              type: Object
            },
            position: {
              type: Number,
              value: 0.1,
              notify: true
            },
            spread: {
              type: Number,
              value: 0,
              notify: true
            },
            loopTime: {
              type: Number,
              value: 0.5,
              notify: true
            },
            numVoices: {
              type: Number,
              value: 1,
              notify: true
            },
            pitch: {
              type: Number,
              value: 0,
              notify: true
            }
          };

          this.listeners = {};
        }

        ready() {}
        attached() {
          this.isOn = false;
          this.paramBoxIsShowing = false;
          this.buttonModel = buildButtonModel.call(this);

          //TODO: change headers into element, that couples with param box
          this.$.header.addEventListener('click', (event) => {
            this.$.paramBox.classList.toggle('grainulator__param-box--active');
            this.$$('parameter-sequencer').resetBoundingClientRect();
          }, false);

          this.parametized = [
            this.position,
            this.spread,
            this.loopTime,
            this.numVoices,
            this.pitch
          ];
          //this.linkPaths(this.position, this.parametized[0]);
          this._printPosition();
        }
        detached() {}
        attributeChanged() {}

        _printPosition () {
          console.log('grain position:', this.position);
          console.log('paramValue:', this.parametized[0]);
          setTimeout(this._printPosition.bind(this), 1000);
        }

        _grainLoop () {
          this.instrumentSet.forEach((instrument) => {
            for (let i = 0; i < this.numVoices; i++) {
              let position = getPosition(this.position, instrument.getDuration(), this.spread);
              let pitch = Math.round(this.pitch);
              instrument.play(pitch, 0, position);
            }
          });

          if (this.isOn) {
            let timeOut = this.loopTime * 1000;
            setTimeout(this._grainLoop.bind(this), timeOut);
          }

        }

      }
      Polymer(CustomGrainulator);

      function getPosition (normalPosition, duration, spreadUpperBound) {
        let spread = getPosNeg() * spreadUpperBound * Math.random();
        let position = (normalPosition * duration) + spread;
        return Math.max(0, Math.min(position, duration));
      }

      function getPosNeg () {
        return Math.random() < 0.5 ? -1 : 1;
      }

      function buildButtonModel () {
        return {
          callback: (isOn) => {
            this.isOn = isOn;
            if (isOn) {
              this._grainLoop();
            }
          }
        };
      }

    })();
  </script>

</dom-module>
