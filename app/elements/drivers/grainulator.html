<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="custom-grainulator">
  <template>
    <style>
      :host {
        display: block;
        font-size: 12px;
      }
      .grainulator {
        display: block;
        width: 200px;
        border: 1px solid black;
      }
      .grainulator-header {
        background-color: #999;
        width: 100%;
      }
      .grainulator-button {
        width: 60px;
        height: 30px;
      }
    </style>

    <div class="grainulator">
      <element-header label="Grainulator" removable="{{removable}}"></element-header>

      <div class="grainulator-button">
        <simple-button button-model="{{buttonModel}}"></simple-button>
      </div>

      <parameter-display
        model="{{position}}"
        label="Position"
        lower-bound="0"
        upper-bound="1">
      </parameter-display>

      <parameter-display
        model="{{spread}}"
        label="Spread"
        lower-bound="0"
        upper-bound="1">
      </parameter-display>

      <parameter-display
        model="{{loopTime}}"
        label="Loop Time"
        lower-bound="0.01"
        upper-bound="1">
      </parameter-display>

      <parameter-display
        model="{{numVoices}}"
        label="Voices"
        lower-bound="1"
        upper-bound="6">
      </parameter-display>

      <parameter-display
        model="{{pitch}}"
        label="Pitch"
        lower-bound="-12"
        upper-bound="12">
      </parameter-display>

    </div>

  </template>

  <script>
    (function() {
      'use strict';

      class CustomGrainulator {

        beforeRegister() {
          this.is = 'custom-grainulator';

          this.properties = {
            instrumentSet: {
              type: Object
            },
            removable: {
              type: Object
            },
            position: {
              type: Number,
              value: 0.1
            },
            spread: {
              type: Number,
              value: 0
            },
            loopTime: {
              type: Number,
              value: 0.5
            },
            numVoices: {
              type: Number,
              value: 1
            },
            pitch: {
              type: Number,
              value: 0,
              test: 0.5
            }
          };

          this.listeners = {};
        }

        ready() {}
        attached() {
          this.isOn = false;
          this.buttonModel = buildButtonModel.call(this);
        }
        detached() {}
        attributeChanged() {}

        _grainLoop () {
          this.instrumentSet.forEach((instrument) => {
            for (let i = 0; i < this.numVoices; i++) {
              let position = getPosition(this.position, instrument.getDuration(), this.spread);
              let pitch = Math.round(this.pitch);
              instrument.play(pitch, 0, position);
            }
          });

          if (this.isOn) {
            let timeOut = this.loopTime * 1000;
            setTimeout(this._grainLoop.bind(this), timeOut);
          }

        }

      }
      Polymer(CustomGrainulator);

      function getPosition (normalPosition, duration, spreadUpperBound) {
        let spread = getPosNeg() * spreadUpperBound * Math.random();
        let position = (normalPosition * duration) + spread;
        return Math.max(0, Math.min(position, duration));
      }

      function getPosNeg () {
        return Math.random() < 0.5 ? -1 : 1;
      }

      function buildButtonModel () {
        return {
          callback: (isOn) => {
            this.isOn = isOn;
            if (isOn) {
              this._grainLoop();
            }
          }
        };
      }

    })();
  </script>

</dom-module>
